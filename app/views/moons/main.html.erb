<div class="site-wrapper">
  <h4>Current UTC Offset: <span class="timezone-display"></span></h4>
  <div class="site-container">
    <h1>Is the Moon void of course ?</h1>
    <h2 class="void-message">nope.</h2>
    <h3 class="next-void-message">moin was/will be void on date</h3>
    <h3 class="sign-message">moon is in sign</h3>
    <div class="schedule hidden"><%= @schedule %></div>
    <% @ingresses %>
    <% ingresses = @ingresses.children.map {|child| child.text.split(/\s{2}/)} %>
    <% ingresses.shift  %>
    <% ingresses = ingresses.map {|array| array.join('***')} %>
    <% ingresses.join("$$$") %>

    <div class="ingresses hidden"><%= ingresses.join("$$$") %></div>

    </div>
    <div class="moon-image" >
    </div>
  </div>
</div>

<script type="module">

  var offset = new Date().getTimezoneOffset();
  const offsetHours = -offset/60;
  const timeZoneDisplay = document.querySelector('.timezone-display');

  function setTimeZone (offsetHours) {
    if (offsetHours > 0) {
      timeZoneDisplay.innerText = `+${offsetHours}:00`
    } else if (offsetHours < 0) {
      timeZoneDisplay.innerText = `-${offsetHours}:00`
    } else {
      timeZoneDisplay.innerText = `+00:00`
    }
  }
  function formatDate(date) {
  var monthNames = [
    "January", "February", "March",
    "April", "May", "June", "July",
    "August", "September", "October",
    "November", "December"
  ];

  var day = date.getDate();
  var monthIndex = date.getMonth();
  var year = date.getFullYear();
  var hour = date.getHours();
  var minutes = date.getMinutes();

  return `${day} ${monthNames[monthIndex]} ${year} at ${hour}:${minutes}`;
}
  setTimeZone(offsetHours);

  const voidBox = document.querySelector('.void-message')
  const c = document.querySelector('.schedule')
  const table = new DOMParser().parseFromString(c.innerText, 'text/html');
  const rows = table.getElementsByTagName('tr')
  const cal = []
  let group = []
  let row = {}
  let i = 0
  for (i = 1; i < rows.length - 1; i++) {
    if (rows[i].innerText.match(/Moon\sBegins/)) {
      row = {}
      row['beginVocDate'] = rows[i].children[0].innerText
      row['beginVocTime'] = rows[i].children[1].innerText
      row['beginVocSign'] = rows[i].children[3].innerText
      group.push(row)
    } else if (rows[i].innerText.match(/Moon\sEnters/)) {
      row = {}
      row['endVocDate'] = rows[i].children[0].innerText
      row['endVocTime'] = rows[i].children[1].innerText
      row['endVocSign'] = rows[i].children[3].innerText
      group.push(row)
      if (group.length === 2) {
          cal.push(group)
          group = []
      }
    }
  }
  let lastEnd = 'unset'
  let nextBegin = 'unset'
  let currentSign = ''
  cal.forEach((row, index) => {
    let beginString = row[0]['beginVocDate'] + ' ' + row[0]['beginVocTime'] + " UTC"

    let endString = row[1]['endVocDate'] + ' ' + row[1]['endVocTime'] + " UTC"
    // begin and end are converted automatically to the user's timezone
    let begin = new Date(beginString)
    let end = new Date(endString)
    let now = new Date()
    console.log(`now is ${now}`);
    console.log(`begin is ${begin}`);
    console.log(`end is ${end}`);
    console.log(now >= begin && now < end)

    if (now < begin && nextBegin === 'unset' && voidBox.innerText !== 'Yup.') {
      nextBegin = begin
      currentSign = row[0]['beginVocSign']
      voidBox.innerText = 'Nope.'
      document.querySelector('.next-void-message').innerText = `Moon will be void on ${formatDate(nextBegin)} local time.`
    }

  })
  i = cal.length - 1
  for (cal.length - 1; i > 0; i--) {
    let beginString = cal[i][0]['beginVocDate'] + ' ' + cal[i][0]['beginVocTime'] + " UTC"
    let endString = cal[i][1]['endVocDate'] + ' ' + cal[i][1]['endVocTime'] + " UTC"
    let begin = new Date(beginString)
    let end = new Date(endString)
    let now = new Date()

    if (now > end && lastEnd === 'unset' && voidBox.innerText !== 'Yup.') {
      currentSign = cal[i][1]['endVocSign']
      lastEnd = end
      voidBox.innerText = 'Nope.'
    }


    if (now >= begin && now < end) {
      currentSign = cal[i][0]['beginVocSign']
      voidBox.innerText = 'Yup.'
      let d = new Date(cal[i][0]['beginVocDate'] + " " + cal[i][0]['beginVocTime'] + "+00:00")

      console.log(formatDate(d))
      document.querySelector('.next-void-message').innerText = `Moon turned void on ${formatDate(d)} local time.`
       let e = new Date(cal[i][1]['endVocDate'] + " " + cal[i][1]['endVocTime'] + "+00:00")

    document.querySelector('.next-void-message').insertAdjacentHTML('afterend', `<h3>Void ends on ${formatDate(e)} local time.</h3>`)
    }
  }

  const el = document.querySelector('.ingresses').innerText
  const ingresses = el.split('$$$')
  let rose = []
  ingresses.forEach((ingress) => {
    rose.push(ingress.split('***'))
  })
  rose.forEach((r) => {
  let d = new Date(r[0].trim() + "+00:00")
  let now = new Date()
    if (d.getMonth() === now.getMonth() && d.getDate() === now.getDate()) {
      if (now < d) {
        console.log('moon is not ingressed yet')
      } else if (now >= d) {
        console.log(`moon is ingressed at ${d}`)

      }
      console.log(d)
      console.log(r[1].trim().replace(/Moon\senters/, '').trim())
      console.log(now)
      currentSign = r[1].trim().replace(/Moon\senters/, '').trim()
    }
  })
  document.querySelector('.sign-message').innerText = `Moon is in ${currentSign}`
</script>

